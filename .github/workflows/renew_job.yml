name: Zampto Renew

on:
  workflow_dispatch:
  schedule:
    - cron: '5 4 * * *'

permissions:
  contents: write

jobs:
  run-zampto:
    runs-on: ubuntu-latest

    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: æ£€æŸ¥ Secrets
        run: |
          if [ -z "${{ secrets.USERNAME }}" ] || [ -z "${{ secrets.PASSWORD }}" ]; then
            echo "âŒ USERNAME æˆ– PASSWORD æœªè®¾ç½®ï¼Œç»ˆæ­¢æ‰§è¡Œã€‚"
            exit 1
          fi

      # ========================================================
      # ğŸš€ æ ¸å¿ƒä¿®æ”¹ï¼šå®‰è£…å¹¶å¯åŠ¨ Gost æœ¬åœ°ä»£ç†è½¬å‘
      # ========================================================
      - name: å¯åŠ¨æœ¬åœ°ä»£ç†è½¬å‘ (Gost)
        if: ${{ secrets.CHROME_PROXY != '' }}
        env:
          UPSTREAM_PROXY: ${{ secrets.CHROME_PROXY }}
        run: |
          echo "ğŸŒ æ­£åœ¨å®‰è£… Gost ä»£ç†å·¥å…·..."
          # ä¸‹è½½ gost (Linux amd64)
          wget -q https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz
          gunzip gost-linux-amd64-2.11.5.gz
          mv gost-linux-amd64-2.11.5 gost
          chmod +x gost
          
          echo "ğŸ”„ å¯åŠ¨ Gost è½¬å‘æœåŠ¡..."
          # -L=:8888  -> ç›‘å¬æœ¬åœ° 8888 ç«¯å£
          # -F=...    -> è½¬å‘ç»™ä¸Šæ¸¸å¸¦å¯†ç çš„ä»£ç†
          # nohup &   -> åå°è¿è¡Œ
          nohup ./gost -L=:8888 -F="$UPSTREAM_PROXY" > /dev/null 2>&1 &
          
          # ç­‰å¾…2ç§’ç¡®ä¿å¯åŠ¨æˆåŠŸ
          sleep 2
          echo "âœ… æœ¬åœ°ä»£ç†å·²å¯åŠ¨: http://127.0.0.1:8888"

      - name: æ‰§è¡Œ Zampto Renew å®¹å™¨
        env:
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_USERID: ${{ secrets.TG_USERID }}
          # âš ï¸ æ³¨æ„ï¼šè¿™é‡Œæ ¹æ®æ˜¯å¦æœ‰ä»£ç†ï¼Œå†³å®šä¼ æœ¬åœ°åœ°å€è¿˜æ˜¯ç©ºå€¼
          # å¦‚æœ secrets.CHROME_PROXY ä¸ä¸ºç©ºï¼Œåˆ™ä¼ æœ¬åœ°è½¬æ¢åçš„åœ°å€ï¼Œå¦åˆ™ä¼ ç©º
          FINAL_PROXY: ${{ secrets.CHROME_PROXY != '' && 'http://127.0.0.1:8888' || '' }}
        run: |
          # âš ï¸ å…³é”®å‚æ•°ï¼š--network host
          # è¿™ä½¿å¾—å®¹å™¨å¯ä»¥ç›´æ¥è®¿é—® Runner ä¸Šçš„ 127.0.0.1:8888
          
          docker run -i \
            --network host \
            -e USERNAME="$USERNAME" \
            -e PASSWORD="$PASSWORD" \
            -e TG_TOKEN="$TG_TOKEN" \
            -e TG_USERID="$TG_USERID" \
            -e CHROME_PROXY="$FINAL_PROXY" \
            -v ${{ github.workspace }}/zampto_server.py:/app/zampto_server.py \
            -v ${{ github.workspace }}/requirements.txt:/app/requirements.txt \
            -v ${{ github.workspace }}/screenshots:/app/screenshots \
            ghcr.io/liveqte/zampto_renew:latest

      # --- é˜²æš‚åœä»£ç  ---
      - name: Commit time.txt to repo
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if [ ! -f time.txt ]; then
            echo "é¦–æ¬¡ç”Ÿæˆæ—¶é—´ï¼š$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          else
            echo "$(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          fi
          git add time.txt
          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            git commit -m "â±ï¸ æ›´æ–°æ—¶é—´æ–‡ä»¶: $(date +'%Y-%m-%d %H:%M:%S')"
            git push origin HEAD:main
          fi

      - name: ä¸Šä¼ æˆªå›¾äº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots
