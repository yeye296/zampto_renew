name: Zampto Renew

on:
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®è§¦å‘
  schedule:
    - cron: '5 4 * * *'   # æ¯å¤©å‡Œæ™¨è‡ªåŠ¨è¿è¡Œ

permissions:
  contents: write

jobs:
  run-zampto:
    runs-on: ubuntu-latest

    steps:
      - name: æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      # ----------------------------------------------------------------
      # 1. ç¯å¢ƒæ£€æŸ¥ä¸ Gost ä»£ç†æœåŠ¡å¯åŠ¨
      # ----------------------------------------------------------------
      - name: å‡†å¤‡ä»£ç†ç¯å¢ƒ
        id: proxy-setup
        env:
          RAW_PROXY: ${{ secrets.CHROME_PROXY }}
        run: |
          # æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†ä»£ç†
          if [ -z "$RAW_PROXY" ]; then
            echo "â„¹ï¸ æœªé…ç½® CHROME_PROXYï¼Œå°†ä½¿ç”¨ç›´è¿æ¨¡å¼ã€‚"
            echo "USE_LOCAL_PROXY=false" >> $GITHUB_ENV
            exit 0
          fi

          echo "ğŸŒ æ£€æµ‹åˆ°ä»£ç†é…ç½®ï¼Œæ­£åœ¨å®‰è£… Gost..."
          
          # ä¸‹è½½å¹¶å®‰è£… Gost
          wget -q -O gost.gz https://github.com/ginuerzh/gost/releases/download/v2.11.5/gost-linux-amd64-2.11.5.gz
          gunzip gost.gz
          chmod +x gost
          
          # å¯åŠ¨åå°è½¬å‘: ç›‘å¬ 8888 -> è½¬å‘ç»™ secrets ä¸­çš„ä»£ç†
          nohup ./gost -L=:8888 -F="$RAW_PROXY" > /dev/null 2>&1 &
          
          # ç­‰å¾…æœåŠ¡å°±ç»ª
          sleep 3
          
          # ç®€å•æµ‹è¯•ä¸€ä¸‹ç«¯å£æ˜¯å¦é€š
          if nc -z 127.0.0.1 8888; then
            echo "âœ… æœ¬åœ°ä»£ç†æœåŠ¡å¯åŠ¨æˆåŠŸ: 127.0.0.1:8888"
            echo "USE_LOCAL_PROXY=true" >> $GITHUB_ENV
          else
            echo "âŒ Gost å¯åŠ¨å¤±è´¥ï¼Œç«¯å£æœªå¼€æ”¾ã€‚"
            exit 1
          fi

      # ----------------------------------------------------------------
      # 2. è¿è¡Œ Python è„šæœ¬å®¹å™¨
      # ----------------------------------------------------------------
      - name: æ‰§è¡Œ Zampto Renew å®¹å™¨
        env:
          USERNAME: ${{ secrets.USERNAME }}
          PASSWORD: ${{ secrets.PASSWORD }}
          TG_TOKEN: ${{ secrets.TG_TOKEN }}
          TG_USERID: ${{ secrets.TG_USERID }}
        run: |
          # åŠ¨æ€å†³å®šä¼ ç»™å®¹å™¨çš„ä»£ç†åœ°å€
          if [ "$USE_LOCAL_PROXY" == "true" ]; then
            FINAL_PROXY="http://127.0.0.1:8888"
            echo "ğŸš€ å®¹å™¨å°†ä½¿ç”¨æœ¬åœ°è½¬å‘ä»£ç†: $FINAL_PROXY"
          else
            FINAL_PROXY=""
            echo "ğŸš€ å®¹å™¨å°†ä½¿ç”¨ç›´è¿æ¨¡å¼"
          fi

          # âš ï¸ å…³é”®å‚æ•°ï¼š--network host
          # è¿™è®©å®¹å™¨å…±äº« Runner çš„ç½‘ç»œæ ˆï¼Œä»è€Œèƒ½è®¿é—® localhost:8888
          docker run -i \
            --network host \
            -e USERNAME="$USERNAME" \
            -e PASSWORD="$PASSWORD" \
            -e TG_TOKEN="$TG_TOKEN" \
            -e TG_USERID="$TG_USERID" \
            -e CHROME_PROXY="$FINAL_PROXY" \
            -v ${{ github.workspace }}/zampto_server.py:/app/zampto_server.py \
            -v ${{ github.workspace }}/requirements.txt:/app/requirements.txt \
            -v ${{ github.workspace }}/screenshots:/app/screenshots \
            ghcr.io/liveqte/zampto_renew:latest

      # ----------------------------------------------------------------
      # 3. é˜²æš‚åœæœºåˆ¶ (æäº¤æ—¶é—´æ–‡ä»¶)
      # ----------------------------------------------------------------
      - name: æäº¤è¿è¡Œæ—¥å¿—é˜²æš‚åœ
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ ! -f time.txt ]; then
            echo "Init: $(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          else
            echo "Update: $(date +'%Y-%m-%d %H:%M:%S')" > time.txt
          fi
          
          git add time.txt
          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–"
          else
            git commit -m "â±ï¸ Auto-update timestamp"
            git push origin HEAD:main
          fi

      - name: ä¸Šä¼ æˆªå›¾äº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots
          path: screenshots
